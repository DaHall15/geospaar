<!DOCTYPE html>
<html>
  <head>
    <title>Geospatial Analysis with R</title>
    <meta charset="utf-8">
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/lucy.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/middlebury-fonts.css" rel="stylesheet" />
    <link rel="stylesheet" href="themes/class3plus.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Geospatial Analysis with R
## Class 6

---

# Temporal mosaicking of images

&lt;img src="figures/planet-imgs.png" width="100%" style="display: block; margin: auto;" /&gt;
&lt;img src="figures/planet-mask.png" width="50%" style="display: block; margin: auto;" /&gt;

---


```r
library(raster)
library(stars)
p1 &lt;- "~/Downloads/mosaic-tests/"
fs &lt;- dir(p1, pattern = "masked.tif$", full.names = TRUE)
rs &lt;- lapply(fs, raster)

exts &lt;- t(sapply(rs, function(x) sf::st_bbox(x)))
fl &lt;- list(min, min, max, max)
mext &lt;- sapply(1:4, function(x) fl[[x]](exts[, x]))[c(1, 3, 2, 4)]
names(mext) &lt;- c("xmin", "xmax", "ymin", "ymax")
mext &lt;- st_bbox(mext, crs = st_crs(rs[[1]]))
stext &lt;- st_as_stars(mext, nx = unname(diff(mext[c(1, 3)]) / 3), 
                     ny = unname(diff(mext[c(2, 4)]) / 3))

bm &lt;- lapply(1:length(fs), function(x) {  # x &lt;- 2
  print(x)
  b &lt;- rs[[x]]
  m &lt;- resample(b, stars:::st_as_raster(stext))
  m
})

b1 &lt;- stack(bm)
plot(b1)
mymedian &lt;- function(x) median(x, na.rm = TRUE)
mymean &lt;- function(x) mean(x, na.rm = TRUE)
b1med &lt;- calc(b1, mymedian)
b1mean &lt;- calc(b1, mymean)
mxs &lt;- sapply(1:nlayers(b1), function(x) cellStats(b1[[x]], max))
```

---

```r
cols &lt;- gray.colors(100, start = 0.01, end = 0.99, gamma = 2.2, alpha = NULL)
png("inst/slides/figures/planet-imgs.png", height = 2, width = 7.5, res = 300, 
    units = "in", bg = "black")
par(mfrow = c(2, 10), mar = rep(0, 4))
for(i in 1:20) {
  plot(b1[[i]], axes = FALSE, legend = FALSE, main = NULL, col = cols, 
       zlim = c(0, 7000), box = FALSE)
  box(lty = 1, col = 'white')
}
dev.off()

png("inst/slides/figures/planet-mask.png", height = 3, width = 4, res = 300, 
    units = "in", bg = "black")
par(mfrow = c(1, 2), mar = c(0, 0, 2, 0))
plot(b1med, col = cols, axes = FALSE, legend = FALSE, box = FALSE, 
     main = "Median filter", zlim = c(500, 4800), col.main = "white")
box(lty = 1, col = 'white')
plot(b1mean, col = cols, axes = FALSE, legend = FALSE, box = FALSE, 
     main = "Mean filter", zlim = c(500, 4800), col.main = "white")
box(lty = 1, col = 'white')
dev.off()
```

---
# Today

- The `R` ecosystem, continued
- Coding!

---
# What we should know by now

- Key concepts/tools of reproducibility and why we use them
- How to set up a package project under `git` VCS
  - How to basic branching, simply merging
- How `R` packages are structured
- Understand basic building blocks of `R` ecosystem
  - Data types
  - Structures
  - Functions
  - Classes and OO systems
  - Environments and search path

---
# The R Ecosystem

&lt;img src="figures/class5_u1m2.png" width="70%" style="display: block; margin: auto;" /&gt;

---

## OO

### Base system? 

```r
x &lt;- 1:10
!is.object(x)  # if TRUE, base object. 
```

```
## [1] TRUE
```

### S3 system?

```r
x &lt;- lm(x ~ rev(x))
!is.object(x)  # if TRUE, base object. 
```

```
## [1] FALSE
```

```r
!isS4(x)  # it’s S3
```

```
## [1] TRUE
```

---
## OO

### S4 system? 

```r
x &lt;- raster::raster(nrow = 10, ncol = 10)
str(x)
```

```
## Formal class 'RasterLayer' [package "raster"] with 12 slots
##   ..@ file    :Formal class '.RasterFile' [package "raster"] with 13 slots
##   .. .. ..@ name        : chr ""
##   .. .. ..@ datanotation: chr "FLT4S"
##   .. .. ..@ byteorder   : chr "little"
##   .. .. ..@ nodatavalue : num -Inf
##   .. .. ..@ NAchanged   : logi FALSE
##   .. .. ..@ nbands      : int 1
##   .. .. ..@ bandorder   : chr "BIL"
##   .. .. ..@ offset      : int 0
##   .. .. ..@ toptobottom : logi TRUE
##   .. .. ..@ blockrows   : int 0
##   .. .. ..@ blockcols   : int 0
##   .. .. ..@ driver      : chr ""
##   .. .. ..@ open        : logi FALSE
##   ..@ data    :Formal class '.SingleLayerData' [package "raster"] with 13 slots
##   .. .. ..@ values    : logi(0) 
##   .. .. ..@ offset    : num 0
##   .. .. ..@ gain      : num 1
##   .. .. ..@ inmemory  : logi FALSE
##   .. .. ..@ fromdisk  : logi FALSE
##   .. .. ..@ isfactor  : logi FALSE
##   .. .. ..@ attributes: list()
##   .. .. ..@ haveminmax: logi FALSE
##   .. .. ..@ min       : num Inf
##   .. .. ..@ max       : num -Inf
##   .. .. ..@ band      : int 1
##   .. .. ..@ unit      : chr ""
##   .. .. ..@ names     : chr ""
##   ..@ legend  :Formal class '.RasterLegend' [package "raster"] with 5 slots
##   .. .. ..@ type      : chr(0) 
##   .. .. ..@ values    : logi(0) 
##   .. .. ..@ color     : logi(0) 
##   .. .. ..@ names     : logi(0) 
##   .. .. ..@ colortable: logi(0) 
##   ..@ title   : chr(0) 
##   ..@ extent  :Formal class 'Extent' [package "raster"] with 4 slots
##   .. .. ..@ xmin: num -180
##   .. .. ..@ xmax: num 180
##   .. .. ..@ ymin: num -90
##   .. .. ..@ ymax: num 90
##   ..@ rotated : logi FALSE
##   ..@ rotation:Formal class '.Rotation' [package "raster"] with 2 slots
##   .. .. ..@ geotrans: num(0) 
##   .. .. ..@ transfun:function ()  
##   ..@ ncols   : int 10
##   ..@ nrows   : int 10
##   ..@ crs     :Formal class 'CRS' [package "sp"] with 1 slot
##   .. .. ..@ projargs: chr "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
##   ..@ history : list()
##   ..@ z       : list()
```

```r
!is.object(x)  # if TRUE, base object. 
```

```
## [1] FALSE
```

```r
!isS4(x)  # it’s S3
```

```
## [1] FALSE
```

```r
!is(x, "refClass") # it’s S4; otherwise it’s RC.
```

```
## [1] TRUE
```

---

## Environments
&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="figures/class5_envs.png" alt="http://adv-r.had.co.nz/Environments.html" width="70%" /&gt;
&lt;p class="caption"&gt;http://adv-r.had.co.nz/Environments.html&lt;/p&gt;
&lt;/div&gt;

---
# Coding
- Creating data
  - 1-D
    - random number generation 
  - 2-D
- Manipulating data
  - Indexing/subsetting
  - Replacement

---
## Random numbers


```r
set.seed(1)
v &lt;- sample(1:1000, size = 20, replace = TRUE)
hist(v, col = "blue")

set.seed(1)
v &lt;- runif(n = 20, min = 0, max = 1000)
hist(v, col = "blue")

set.seed(1)
v &lt;- rnorm(n = 20, mean = 500, sd = 100)
hist(v, col = "blue")

set.seed(1)
v &lt;- rpois(n = 20, lambda = 5)
hist(v, col = "blue")

set.seed(1)
v &lt;- rgamma(n = 20, shape = 0.7, scale = 10)
hist(v, col = "blue")

set.seed(1)
v &lt;- rbinom(n = 20, size = 1, prob = 0.5)
hist(v, col = "blue")
```

---

## Create your own data
- Vectors
  - Integer
  - Numeric
  - Character
  - Combine into list

---
## 2-d structures

- Combine
  - Vectors into `matrix`
  - Vectors into `data.frame`

---
## Indexing/subsetting
- 1-d
- 2-d

---
## Replacement
- Vectors
- Lists
- `matrix`
- `data.frame`
- `data.frame`/`matrix` in lists
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
